<% decorate_connection = ->(connection) do %>
    <% id = connection.id %>
    <% case connection.state.to_sym %>
    <% when :in_progress %>
        <div>
            Connecting Your Account, Please Wait...
        </div>
    <% when :error %>
        <div>
            Error
            (<%= link_to 'Try Again?', controller: :connections, action: :new, service: connection.short_service_name,
                         id: id %>) - <%= link_to('Delete', connection_path(id), method: :delete) %>
        </div>
    <% when :expired %>
        <div>
            Your Session Has Expired
            (<%= link_to 'Reconnect', controller: :connections, action: :new, service: connection.short_service_name,
                         id: id %>) - <%= link_to('Delete', connection_path(id), method: :delete) %>
        </div>
    <% when :success %>
        <div>
            <%= connection.name %> - <%= link_to('Delete', connection_path(id), method: :delete) %>
        </div>
    <% else
         raise "Invalid State (was #{state})"
       end
    end %>

<% new_connection = ->(name) do %>
    <p>
        <%= link_to 'Create New Connection', controller: :connections, action: :new, service: name %>
    </p>
<% end %>

<% max_connections = current_user.has_max_connections %>
<% connections = current_user.connections.load %>
<h4>Box:</h4>
<% connections.where(type: 'BoxConnection').order('id').each &decorate_connection
   new_connection['box'] unless max_connections %>
<h4>Dropbox:</h4>
<% connections.where(type: 'DropboxConnection').order('id').each &decorate_connection
   new_connection['dropbox'] unless max_connections %>
<h4>Google Drive:</h4>
<% connections.where(type: 'GoogleConnection').order('id').each &decorate_connection
   new_connection['google'] unless max_connections %>
<h4>SkyDrive:</h4>
<% connections.where(type: 'SkydriveConnection').order('id').each &decorate_connection
   new_connection['skydrive'] unless max_connections %>